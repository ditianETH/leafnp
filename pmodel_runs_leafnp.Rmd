---
title: "P-model simulations for leafNP"
author: "Beni"
date: "1/15/2021"
output: html_document
---

```{r}
#knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ingestr)
library(rsofun)
```

## Site meta information

Read the site meta information data frame, created in `leafnp.Rmd`. For site ensemble P-model simulations, it must contain the following columns:

- `sitename`
- `lon`
- `lat`
- `elv`
- `year_start`
- `year_end`

```{r}
df_sites <- read_csv("data/df_sites.csv")
```

## Determine gridcells

Since we're extracting forcing data from global files provided at half-degree resolution, we want to avoid extracting data for two sites separately if they are located within the same gridcell. Therefore, determine the unique gridcells.

```{r}
## bin
dlon <- 0.5
dlat <- 0.5
lon_breaks <- seq(from = floor(min(df_sites$lon)), to = ceiling(max(df_sites$lon)), by = dlon)
lat_breaks <- seq(from = floor(min(df_sites$lat)), to = ceiling(max(df_sites$lat)), by = dlat)

df_sites <- df_sites %>%
  ungroup() %>% 
  mutate(ilon = cut(lon, 
                    breaks = lon_breaks
                    ),
         ilat = cut(lat, 
                    breaks = lat_breaks
                    )
         ) %>% 
  mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)),
         lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ),
         lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ),
         lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) )
         ) %>% 
  mutate(lon_mid = (lon_lower + lon_upper)/2,
         lat_mid = (lat_lower + lat_upper)/2) %>% 
  dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper) %>% 
  mutate(cellname = paste0("icell_", lon_mid, "_", lat_mid))

## save again, now with lon_mid, lat_mid
save(df_sites, file = "data/df_sites.RData")

df_cells <- df_sites %>% 
  dplyr::select(sitename = cellname, lon = lon_mid, lat = lat_mid) %>% 
  distinct() %>% 

  ## set for reading all available years, subset to required years for each site later
  mutate(year_start = 1979, year_end = 2018)

write_csv(df_cells, path = "data/df_cells.csv")
```

## Read forcing data

### Climate

Use the ingestr package to read WATCH-WFDEI climate data as daily time series for each cell that contains at least one site. 

Actually it's best to do this on the Euler cluster. Submit it as a job with the submission file `submit_get_watch_cru.sh` (a Bash script), running an R script (`rscript_get_watch_cru.R`) that contains the same code as the chunk below.

```{r eval=FALSE}
ddf_watch <- ingest(
  siteinfo = df_cells,
  source    = "watch_wfdei",
  getvars   = c("temp", "prec", "ppfd", "vpd", "patm"),
  dir       = "~/data/watch_wfdei/"  # adjust this with your local path
)
save(ddf_watch, file = "data/ddf_watch.RData")


ddf_cru <- ingest(
  siteinfo = df_cells,
  source    = "cru",
  getvars   = "ccov",
  dir       = "~/data/cru/ts_4.01/"  # adjust this with your local path
)
save(ddf_cru, file = "data/ddf_cru.RData")
```

Combine the two data frames for P-model forcing.

```{r eval=FALSE}
load("data/ddf_watch.RData")
load("data/ddf_cru.RData")

ddf_meteo <- ddf_watch %>% 
  tidyr::unnest(data) %>% 
  left_join(
    ddf_cru %>% 
      tidyr::unnest(data),
    by = c("sitename", "date")
  ) %>% 
  group_by(sitename) %>% 
  tidyr::nest()
```

### CO2

```{r eval=FALSE}
df_co2 <- read_csv("~/data/co2/cCO2_rcp85_const850-1765.csv")
```


## Set P-model parameters

```{r}
params_siml <- list(
  spinup             = TRUE,
  spinupyears        = 10,
  recycle            = 1,
  soilmstress        = TRUE,
  tempstress         = TRUE,
  calc_aet_fapar_vpd = FALSE,
  in_ppfd            = TRUE,
  in_netrad          = FALSE,
  outdt              = 1,
  ltre               = FALSE,
  ltne               = FALSE,
  ltrd               = FALSE,
  ltnd               = FALSE,
  lgr3               = TRUE,
  lgn3               = FALSE,
  lgr4               = FALSE
	)

## calibrated parameters for v3.0 (see https://rpubs.com/stineb/rsofun_benchmark_v30)
params_modl <- list(
	kphio           = 0.09423773,
	soilm_par_a     = 0.33349283,
	soilm_par_b     = 1.45602286,
	vpdstress_par_a = 9999,
	vpdstress_par_b = 9999,
	vpdstress_par_m = 9999
	)

df_soiltexture <- bind_rows(
  top    = tibble(layer = "top",    fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1),
  bottom = tibble(layer = "bottom", fsand = 0.4, fclay = 0.3, forg = 0.1, fgravel = 0.1)
)
```

## Prepare drivers for P-model

Run `prepare_setup_sofun()` to define the simulation settings that contain all the information specified by the two steps above (meta info, and simulation parameters), global simulation parameters are wrapped inside an additional column `params_siml`, added to the site meta info dataframe.
```{r}
df_drivers <- prepare_setup_sofun(siteinfo = df_sites, params_siml = params_siml)
```

Nest site info
```{r}
df_drivers <- df_drivers %>% 
  dplyr::select(sitename, lon, lat, elv) %>% 
  mutate(c4 = FALSE, whc = 240) %>% 
  group_by(sitename) %>% 
  nest() %>% 
  rename(siteinfo = data) %>% 
  left_join(df_drivers %>% 
              dplyr::select(sitename, params_siml, cellname),
            by = "sitename")
```

Add climate forcing and subset time series based on start and end year for this site.
```{r}
subset_forcing <- function(forcing, params_siml){
  forcing %>% 
    dplyr::filter(year(date) >= params_siml$firstyeartrend[1] & 
                  year(date) <  params_siml$firstyeartrend[1] + params_siml$nyeartrend[1])
}

df_drivers <- df_drivers %>% 
  left_join(ddf_meteo %>% 
              rename(cellname = sitename), 
            by = "cellname") %>% 
  mutate(forcing = purrr::map2(forcing, params_siml, ~subset_forcing(.x, .y)))
```

Add soil texture data frame (for completeness, but not actually used).
```{r}
df_drivers <- df_soiltexture %>%
  dplyr::mutate(tmp = 1) %>% 
  group_by(tmp) %>% 
  nest() %>% 
  rename(df_soiltexture = data) %>% 
  right_join(
    df_drivers %>% 
      mutate(tmp = 1),
    by = "tmp"
  ) %>% 
  dplyr::select(-tmp)
```

Right order of columns for `pmap`.
```{r}
df_drivers <- df_drivers %>% 
  dplyr::select(sitename, params_siml, siteinfo, df_soiltexture, forcing)
```

## Run P-model

This is a tiny bit more complicated than in the simplest case (described[here](https://stineb.github.io/rsofun/articles/example_pmodel.html#run-the-model)), because we're combining site meta information from `df_sites` with climate forcing by gridcell, based on the gridcell ID.
```{r}
df_pmodel <- df_drivers %>% 
  dplyr::mutate(out = purrr::pmap(
    .,
    run_pmodel_f_bysite,
    params_modl = params_modl,
    makecheck = TRUE
  ))

save(df_pmodel, file = "data/df_pmodel.RData")

df_pmodel_flat <- df_pmodel %>% 
  unnest(out)
write_csv(df_pmodel_flat, path = "data/df_pmodel_flat.csv")
```
