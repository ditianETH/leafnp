---
title: "Leaf N and P analysis"
author: "Beni Stocker"
date: "1/6/2021"
output: html_document
---

```{r setup, include=FALSE}
library(dplyr)
library(ggplot2)
library(tidyr)
library(readr)
library(purrr)
library(rbeni)
library(ingestr)
```

## Read data

```{r}
df <- read_csv("~/data/LeafNP_tiandi/Global_total_leaf_N_P_Di/global_leaf_NP_total_Di_20210224.csv") %>%  #, col_types = "idddcccdddddccccccc") %>% 
  rename(lon = lon_estimate,
         lat = lat_estimate,
         elv = Alt_Di_check_final) %>% 
  rename(year_start = Sampling_Year_start,
         year_end = Sampling_Year_end) %>% 
  
  ## to be done: make sampling year info machine readable: either in the form of "9999" or "8888_9999"
  separate(Sampling_Month, sep = "_", c("month_start", "month_end")) %>% 
  mutate(month_start = as.numeric(month_start), month_end = as.numeric(month_end)) %>% 
  
  ## arrange by year
  arrange(year_start) %>% 
  
  ## create identifier
  mutate(id = paste0("i", seq(nrow(.))))

## save with added ids and site names
write_csv(df, file = "~/data/LeafNP_tiandi/Global_total_leaf_N_P_Di/global_leaf_NP_total_Di_20210224_PROC.csv")

## look at some distributions
df %>% 
  ggplot(aes(x = leafN, y = ..density..)) +
  geom_histogram()

df %>% 
  ggplot(aes(x = leafP, y = ..density..)) +
  geom_histogram()
```

### Complement missing elevation

```{r}
# df <- read_csv("~/data/LeafNP_tiandi/Global_total_leaf_N_P_Di/global_leaf_NP_total_Di_20210224_PROC.csv")

df_tmp <- df %>% 
  dplyr::filter(is.na(elv)) %>% 
  distinct(lon, lat) %>% 
  mutate(sitename = paste0("i", seq(nrow(.))))

## extract elevation data from etopo1
df_etopo <- ingest(
  df_tmp,
  source = "etopo1",
  dir = "~/data/etopo/"  # adjust this with your local path
  ) %>% 
  unnest(data) %>% 
  
  ## add it again so it has lon and lat
  right_join(df_tmp, by = "sitename") %>% 
  ungroup() %>% 
  rename(elv_etopo = elv) %>% 
  dplyr::select(-sitename)
  
## add etopo elevation data to data frame
df <- df %>% 
  left_join(df_etopo, by = c("lon", "lat")) %>% 
  rowwise() %>% 
  mutate(elv = ifelse(is.na(elv), elv_etopo, elv)) %>% 
  dplyr::select(-elv_etopo) %>% 
  
  ## create new variable site name (sometimes multiple obs are available for one site)
  mutate(sitename = paste0("i_", as.character(lon), "_", as.character(lat), "_", as.character(elv)))

## save with complemented elevation
write_csv(df, file = "~/data/LeafNP_tiandi/Global_total_leaf_N_P_Di/global_leaf_NP_total_Di_20210224_PROC.csv")
```

## Identify sites

Identify sites (unique lon, lat, elevation)

```{r}
df_sites <- df %>%
  distinct(sitename, lon, lat, elv)

## determine start and end year for each site based on available measurements
df_sites <- df %>% dplyr::select(sitename, year_start, year_end) %>% 
  group_by(sitename) %>% 
  summarise(year_start = min(year_start, na.rm = TRUE),
            year_end   = max(year_end, na.rm = TRUE)) %>% 
  right_join(df_sites, by = "sitename")

write_csv(df_sites, file = "~/data/LeafNP_tiandi/Global_total_leaf_N_P_Di/df_sites_leafnp.csv")
write_csv(df_sites, file = "data/df_sites_leafnp.csv")
```

## Data overview

### Observations per species

How many observations per species?

```{r}
tmp <- df %>% 
  group_by(Species) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  arrange(desc(count))

tmp %>% 
  ggplot(aes(x = count, y = ..count..)) +
  geom_histogram()
```

### Observations per genus

How many observations per genus?

```{r}
tmp <- df %>% 
  group_by(Genus) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  arrange(desc(count))

tmp

tmp %>% 
  ggplot(aes(x = count, y = ..count..)) +
  geom_histogram()
```

### Observations per family

How many observations per family?

```{r}
tmp <- df %>% 
  group_by(Family) %>% 
  summarise(count = n()) %>% 
  ungroup() %>% 
  arrange(desc(count))

tmp

tmp %>% 
  ggplot(aes(x = count, y = ..count..)) +
  geom_histogram()
```

### Site distribution

Sites on a global map

```{r}
plot_map_simpl() +
  geom_point(data = df_sites, aes(x = lon, y = lat), color = "red", size = 0.3)
```

<!-- ## Identify cells -->

<!-- Based on half-degree global grid. ACTUALLY NOT NEEDED. -->

<!-- ```{r eval=FALSE} -->
<!-- ## bin to half-degree gridcells for determining climate forcing -->
<!-- dlon <- 2 -->
<!-- dlat <- 2 -->
<!-- lon_breaks <- seq(from = floor(min(df_sites$lon)), to = ceiling(max(df_sites$lon)), by = dlon) -->
<!-- lat_breaks <- seq(from = floor(min(df_sites$lat)), to = ceiling(max(df_sites$lat)), by = dlat) -->

<!-- df_sites <- df_sites %>% -->
<!--   ungroup() %>%  -->
<!--   mutate(ilon = cut(lon,  -->
<!--                     breaks = lon_breaks -->
<!--                     ), -->
<!--          ilat = cut(lat,  -->
<!--                     breaks = lat_breaks -->
<!--                     ) -->
<!--          ) %>%  -->
<!--   mutate(lon_lower = as.numeric( sub("\\((.+),.*", "\\1", ilon)), -->
<!--          lon_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilon) ), -->
<!--          lat_lower = as.numeric( sub("\\((.+),.*", "\\1", ilat) ), -->
<!--          lat_upper = as.numeric( sub("[^,]*,([^]]*)\\]", "\\1", ilat) ) -->
<!--          ) %>%  -->
<!--   mutate(lon_mid = (lon_lower + lon_upper)/2, -->
<!--          lat_mid = (lat_lower + lat_upper)/2) %>%  -->

<!--   ## create cell name to associate with climate input -->
<!--   mutate(cellname = paste0("icell_", as.character(lon_mid), "_", as.character(lat_mid))) %>%  -->
<!--   dplyr::select(-ilon, -ilat, -lon_lower, -lon_upper, -lat_lower, -lat_upper) -->

<!-- write_csv(df_sites, file = "data/df_sites_leafnp.csv") -->

<!-- df_cells <- df_sites %>%  -->
<!--   dplyr::select(cellname, lon_mid, lat_mid) %>%  -->
<!--   distinct() -->

<!-- write_csv(df_cells, file = "data/df_cells_leafnp.csv") -->
<!-- ``` -->

<!-- ```{r} -->
<!-- ## sample one site per cell -->
<!-- df_sites_sampled <- df_sites %>%  -->
<!--   dplyr::select(sitename, lon, lat, elv, cellname) %>% -->
<!--   group_by(cellname) %>%  -->
<!--   sample_n(1) -->

<!-- plot_map_simpl() + -->
<!--   geom_point(data = df_sites_sampled, aes(x = lon, y = lat), color = "red", size = 0.3) -->
<!-- ``` -->

## Complement dataset

*Look into:*

-   Complement dataset with data points where only Nmass or only Pmass is available (no strict requirement to have paired Nmass and Pmass for this analysis).
-   Information about species identity, family, genus

### P-model outputs and climate indeces

The script `rscript_ingest_run_rsofun.R` is used to collect forcing data and run P-model simulations for all sites (N = 2149). Outputs are aggregated by site (annual mean of Vcmax25 and Jmax25, weighted by daily GPP). This also runs the function `R/calc_climate_index.R` on collected climate forcing data to return climate indeces (some of which are complementary to what is collected directly from WorldClim). The output is on Euler and is read here.
```{r}
df_pmodel <- read_csv("~/data/LeafNP_tiandi/df_pmodel_leafnp.csv")
```


### HWSD Soil

Read HWSD for each site. This reads all variables available fro HWSD. Select relevant variables in a separate step.

```{r eval=FALSE}
filn <- "data/df_hwsd.RData"
if (!file.exists(filn)){
  df_hwsd <- ingest(
    df_sites,
    source = "hwsd",
    settings = list(fil = "~/data/hwsd/HWSD_RASTER/hwsd.bil")
    )
  
  ## for some it got info for multiple soil types - take only first ones => TEST INFLUENCE OF THIS
  df_hwsd <- df_hwsd %>% 
    mutate(n_row = purrr::map_int(data, ~nrow(.))) %>% 
    mutate(data = purrr::map(data, ~slice(., 1)))
  
  save(df_hwsd, file = filn)
  
} else {
  load(filn)
}
```

Combine datasets.

```{r}
df <- df %>% 
  left_join(
    df_hwsd %>% 
      unnest(data)
  )
```

### SoilGrids

Define all variables to be extracted from SoilGrids

```{r}
settings_soilgrids <- get_settings_soilgrids(
  varnam = c("nitrogen", "cec"), # xxx please adjust
  layer = 1:3                    # xxx please adjust
  )
```

Get and save data.

```{r}
df_sites <- read_csv("data/df_sites_leafnp.csv")
df_soilgrids <- ingest(
  df_sites,
  source    = "soilgrids",
  settings  = settings_soilgrids
  ) %>% 
  unnest(data)  # to get a normal flat table

save(df_soilgrids, file = "data/df_soilgrids_leafnp.RData")
```


### WISE30sec Soil

Define all variables to be extracted from WISE30sec

```{r}
settings_wise <- get_settings_wise(
  varnam = c("CNrt", "CECS"),  # xxx please adjust
  layer = 1:3                  # xxx please adjust
  )
```

Get and save data.

```{r}
df_wise <- ingest(
  df_sites,
  source    = "wise",
  settings  = settings_wise,
  dir       = "~/data/soil/wise"
  ) %>% 
  unnsest(data)  # to get a normal flat table

dave(df_wise, file = "data/df_wise.RData")
```

### GSDE Soil XXX

Define all variables to be extracted from GSDE. This is not using ingestr.

```{r}
settings_gsde <- list(varnam = c("PBR", "PHH2O"), layer = 1:8)
```

Get data.

```{r}
df_gsde <- ingest(
  df_sites,
  source    = "gsde",
  settings  = settings_gsde,
  dir       = "~/data/soil/shangguan"
  )
```

### Topography index

```{r}
filn <- "data/df_gti.RData"
if (!file.exists(filn)){
  rasta <- raster::raster("~/data/gti_marthews/ga2.nc")
  df_gti <- raster::extract(rasta, sp::SpatialPoints(dplyr::select(df_sites, lon, lat) %>% distinct()), sp = TRUE) %>%
    as_tibble() %>% 
    rename(gti = GDAL.Band.Number.1)
  save(df_gti, file = filn)
} else {
  load(filn)
}

## add to data 
df <- df_gti%>% 
      right_join(
        df,
        by = c("lon", "lat")
      )
```

### CO2

Read CO2 level as the global mean and a mean over all the years over which sampling was done. This means that if we have replicate measurements for a given species at a given site, the measurements are given the same CO2 level. This assumes that replicates are not intended to cover a time period over which the environment changes.

```{r}
df_co2 <- ingest(
  df_sites,
  source  = "co2_mlo",
  verbose = FALSE
  ) %>% 
  
  ## aggregate over years per site
  mutate(co2 = purrr::map_dbl(data, ~{summarise(., co2 = mean(co2)) %>% pull(co2)})) %>% 
  dplyr::select(-data)

## add to data
df <- df_co2 %>% 
  right_join(df, by = "sitename")
```

### Nitrogen deposition

Read N deposition from Lamarque et al. (2011) as NOx and NOy in gN m$^{-2}$ yr$^{-1}$ for respective year and location (based on half-degree input file).

```{r}
filn <- "data/df_ndep.RData"
if (!file.exists(filn)){
  df_ndep <- ingest(
    df_sites %>% 
      ## for some we don't have data beyond 2009
      rowwise() %>% 
      mutate(year_start = min(year_start, 2009),
             year_end = min(year_end, 2009)),
    source    = "ndep",
    timescale = "y",
    dir       = "~/data/ndep_lamarque/",
    verbose   = FALSE
    )
  save(df_ndep, file = filn)
} else {
  load(filn)
}

## take sum of noy and nhx and aggregate over years
df_ndep_agg <- df_ndep %>% 
  mutate(data = purrr::map(data, ~mutate(., ndep = noy + nhx))) %>% 
  mutate(data = purrr::map(data, ~summarise(., ndep = mean(ndep, na.rm = TRUE)))) %>% 
  unnest(data)


```

### Combine all data

```{r}
df <- df %>% 
  left_join(df_ndep_agg, by = "sitename")
...
```

### Extracting from global NetCDF files

This is a code example and is to be used for extracting AI, alpha, and CWDX40 (see [here](https://www.notion.so/computationales/4e2e0ca6b5d3497894c64bed71a4937d?v=0ee5d81cd0fe42ac8ac1ed0a938b3380)).

Use the following files:

-   `~/data/mct_data/cwdx40.nc` for CWDX40.
-   `~/data/sofun_outputs/global_FULL_MODIS-C006_MOD15A2_v3.4/global_FULL_MODIS-C006_MOD15A2_v3.4.a.alpha_MEANANN.nc` for alpha.

```{r}
library(raster)

filn <- "~/data/mct_data/cwdx40.nc"
siteinfo <- tibble(sitename = "id1", lon = 100, lat = 50)  # example for required dataframe structure

## using raster package
rasta <- raster::raster(filn)  # use raster::brick() if data has three dimensions
df <- raster::extract(
    rasta,
    sp::SpatialPoints(dplyr::select(siteinfo, lon, lat)), # , proj4string = sta@crs
    sp = TRUE
    ) %>%
  as_tibble()

## or simply using rbeni
df <- rbeni::extract_pointdata_allsites(filn, df_lonlat = siteinfo)
```
